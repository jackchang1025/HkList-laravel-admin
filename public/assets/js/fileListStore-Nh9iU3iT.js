import{u as $,e as D,f as M,h as P,j}from"./index-BcUQltO2.js";import{d as E}from"./pinia@2.1.7_typescript@5.5.3_vue@3.4.32_typescript@5.5.3_-BSzeUtha.js";import{E as s}from"./element-plus@2.7.7_vue@3.4.32_typescript@5.5.3_-BPm-_N_9.js";import{r}from"./@vue_reactivity@3.4.32-DksAu7zd.js";const v=$(),A=E("fileListStore",()=>{const l=r(!1),a=r({surl:"",url:"",pwd:"",dir:"/",password:"",token:"",account_ids:""}),g=r(null),F=()=>{const i=a.value.dir.split("/");i.pop();const f=i.join("/");return f===""?"/":f},x=async()=>{if(!(!g.value||!await g.value.validate())){if(a.value.surl==="")return s.error("获取链接surl失败");try{u.value=[],l.value=!0;const i=await D(a.value);n.value=i.data,a.value.dir!=="/"&&n.value.list.unshift({category:-1,fs_id:0,isdir:1,local_ctime:0,local_mtime:0,server_ctime:0,server_mtime:0,size:0,md5:"",path:F(),server_filename:"..",dlink:""}),s.success("获取文件列表成功")}finally{l.value=!1}}},o=r({hit_captcha:!1,vcode_str:"",vcode_img:"",vcode_input:""}),n=r({uk:0,shareid:0,randsk:"",list:[]}),u=r([]),p=r([]),S=async(i,f=!1)=>{if(l.value){s.info("请勿重复点击~");return}const k=v.config.min_single_filesize,L=v.config.max_single_filesize;let c=[];if(i){const e=n.value.list.find(t=>t.fs_id===i);if(!e)s.error("获取文件信息失败");else if(e.size<k){s.error("文件过小不会被解析!");return}else if(e.size>L){s.error("文件过大不会被解析!");return}c=[i]}else{let e=u.value.filter(t=>t.isdir!==1);e.length!==u.value.length&&s.error("文件夹不会被解析!"),e=e.filter(t=>t.size>k),e.length!==u.value.length&&s.error("文件过小不会被解析!"),e=e.filter(t=>t.size<L),e.length!==u.value.length&&s.error("文件过大不会被解析!"),c=e.map(t=>t.fs_id)}if(c.length>v.config.max_once){s.error(`一次最多解析${v.config.max_once}个文件`);return}if(c.length===0){s.error("满足要求的文件数量为0");return}let d;try{l.value=!0;const e={uk:n.value.uk,shareid:n.value.shareid,randsk:n.value.randsk,fs_ids:c,password:a.value.password,token:a.value.token,url:a.value.url,surl:a.value.surl,dir:a.value.dir,pwd:a.value.pwd,account_ids:a.value.account_ids};if(o.value.hit_captcha){if(!o.value.vcode_str||!o.value.vcode_input){s.error("请先输入验证码");return}e.vcode_str=o.value.vcode_str,e.vcode_input=o.value.vcode_input}if(d=await M(e),d.data?s.success("解析成功"):(s.success("解析可能失败,请打开控制台查看是否存在报错"),console.log(d)),o.value={hit_captcha:!1,vcode_str:"",vcode_img:"",vcode_input:""},f)return l.value=!1,await _(),d.data.map(t=>({...t,index:0}));w.value=!0,p.value=d.data.map(t=>({...t,index:0}))}catch(e){const{code:t,message:y}=e;if(t&&y&&y.includes("验证码")){const z=await P({password:a.value.password});o.value={hit_captcha:!0,vcode_str:z.data.vcode,vcode_img:z.data.img,vcode_input:""}}}finally{l.value=!1,await _(),await v.getConfig(!1)}},h=r({group_name:"",count:0,size:0}),m=r(""),_=async()=>{try{l.value=!0;const i=await j({token:a.value.token});h.value=i.data,m.value=""}catch(i){m.value=i.message}finally{l.value=!1}},w=r(!1);return{pending:l,fileList:n,getFileList:x,getFileListForm:a,getFileListFormRef:g,selectedRows:u,downloadLinks:p,getDownloadLinks:S,limitForm:h,getLimit:_,limitMessage:m,vcode:o,dialogVisible:w}});export{A as u};
